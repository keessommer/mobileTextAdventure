<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Montserrat&display=swap');
            :root {
                --backgroundColor: black;
                --textColor: white;
            }
            html {
                background-color: var(--backgroundColor);
                transition: background-color 2s;
            }
            p {
                font-size: 20pt;
                font-family: 'Montserrat', sans-serif;
                text-align: center;
                color: var(--textColor);
            }
            a {
                transition: all, 1s;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .highlight {
                background-color: var(--textColor);
                color: var(--backgroundColor);
                transition: all 0.3s;
            }
            .verticalContainer {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                height: 95vh;
            }
            .verticalItem {
                display: flex;
                max-width: 800px;
            }
            .verticalItem.top {
                align-items: flex-end;
                height: 50vh;
            }
            .verticalItem.center {
                align-items: center;
                justify-content: center;
                height: 10vh;
            }
            .verticalItem.bottom {
                align-items: flex-start;
                height: 50vh;
            }

        </style>
    </head>
    <body>
        <div class="verticalContainer">
            <div class="verticalItem top">
                <p id="knotContainer"></p>
            </div>
            <p id="targetDisplayContainer" class="verticalItem center"> </p>
            <div class="verticalItem bottom">
                <p id="stitchContainer"></p>
            </div>
        </div>
    </body>
    <script src="ink.js"></script>
    <script src="script.js"></script>
    <script>
        function clickWord(e) {
            const target = e.target, highlightName = 'highlight', newDisplayText = getTargetTextFromElement(target, true);
            let targetText, targetDisplayText;
            target.classList.toggle(highlightName);
            if (Array.from(target.classList).includes(highlightName)){
                if(!lastSelected) {
                    lastSelected = target;
                    return;
                }
                document.querySelectorAll(`.${highlightName}`).forEach(e => {
                    e.classList.remove(highlightName);
                });
                target.classList.add(highlightName);
                const handleTransitionEnd = () => {
                    target.classList.remove('highlight');
                    target.removeEventListener('transitionend', handleTransitionEnd);
                }
                target.addEventListener('transitionend', handleTransitionEnd);
                const prevTargetText = getTargetTextFromElement(lastSelected);
                const newTargetText = getTargetTextFromElement(target)
                targetText = `${prevTargetText}${newTargetText}`;
                document.getElementById('targetDisplayContainer').innerHTML = `${getTargetTextFromElement(lastSelected, true)} + ${newDisplayText}`;
            }else {
                document.getElementById('targetDisplayContainer').innerHTML = newDisplayText;
                targetText = getTargetTextFromElement(target);
            }
            lastSelected = undefined;
            const targetStitch = `${currentKnot}.${targetText}`;
            story.ChoosePathString(targetStitch);
            if (story.state.currentPathString.split('.')[1] === '0'){
                try{
                    story.ChoosePathString(targetText);
                }
                catch(err){
                    story.ChoosePathString(`${currentKnot}.unparsableOverride`);
                    if (story.state.currentPathString.split('.')[1] === '0'){
                        story.ChoosePathString(unparsableKnot);
                    }
                }
            }

            continueStory();
        }

        function getTargetTextFromElement(target, display){
            let returnText = target.innerHTML
            .toLowerCase()
            .replaceAll('.', '')
            .replaceAll(',', '')
            .replaceAll('<br>', '');
            if(!display){ returnText = returnText.replaceAll(' ', '') }
            return returnText;
        }

        function createLinks(inputString){
            return inputString
            .replaceAll('\n', ' <br>')
            .split(' ')
            .map((w) => `<a onclick="clickWord(event)">${w}</a>`)
            .join(' ');
        }

        function displayText(text, target){
            target.innerHTML = text
            .replaceAll('&', ' ');
        }
        
        function continueKnot(){
            const newString = createLinks(story.ContinueMaximally());
            document.getElementById('stitchContainer').innerHTML = '';
            document.getElementById('targetDisplayContainer').innerHTML = '';
            displayText(newString, document.getElementById('knotContainer'));
        }

        function continueStitch(){
            const newString = createLinks(story.ContinueMaximally());
            displayText(newString, document.getElementById('stitchContainer'));
        }

        function continueStory() {
            let tags;
            try{tags = story.TagsForContentAtPath(getCurrentInkStitch());}
            catch(err){console.warn(`no valid stitch ${err}`)}
            if (currentKnot !== getCurrentInkKnot() || tags && tags.includes('divert')){
                story.Continue();
                const newKnot = getCurrentInkKnot();
                if (newKnot === unparsableKnot) { 
                    continueStitch();
                    story.ChoosePathString(currentKnot);
                } 
                else {
                    currentKnot = newKnot;
                    continueKnot();
                }
            }else {
                continueStitch();
            }
        }

        function getCurrentInkKnot() {
            return story.state.currentPathString ? story.state.currentPathString.split('.')[0] : undefined;
        }

        function getCurrentInkStitch() {
            return story.state.currentPathString.split('.').slice(0, 2).join('.');
        }

        function setLightTheme() {
            let root = document.documentElement;
            root.style.setProperty('--backgroundColor', 'white');
            root.style.setProperty('--textColor', 'black');
        }

        function setDarkTheme() {
            let root = document.documentElement;
            root.style.setProperty('--backgroundColor', 'black');
            root.style.setProperty('--textColor', 'white');
        }

        const unparsableKnot = 'unparsable', story = new inkjs.Story(storyContent);
        let currentKnot, lastSelected;
        story.BindExternalFunction('setLight', setLightTheme);
        story.BindExternalFunction('setDark', setDarkTheme);
        continueStory();
    </script>
</html>